import React, { useState, useEffect, useMemo } from 'react';
import { 
  Activity, Droplet, Beaker, Play, Pause, RotateCcw, 
  LayoutDashboard, Settings, HeartPulse, Brain, Zap, 
  GitCompare, UserCheck, Stethoscope, Thermometer, ArrowRight,
  AlertTriangle
} from 'lucide-react';

// --- Types & Constants ---

type FluidType = 'saline' | 'hartmanns' | 'plasmalyte' | 'albumin4' | 'albumin20' | 'bicarb_dex' | 'mannitol';
type DistributionProfile = 'ecf' | 'tbw' | 'plasma' | 'plasma_expand';
type TabView = 'stewart' | 'starling' | 'micro' | 'comparator' | 'cases';

interface FluidData {
  name: string;
  na: number; cl: number; k: number; mg: number; ca: number;
  organic: number; albuminContent: number; hco3_load: number;
  osm: number; // mOsm/kg
  description: string;
  distribution: DistributionProfile;
}

const FLUIDS: Record<FluidType, FluidData> = {
  saline: {
    name: "0.9% Saline",
    na: 154, cl: 154, k: 0, mg: 0, ca: 0, organic: 0, albuminContent: 0, hco3_load: 0, osm: 308,
    description: "SID=0. Hyperchloraemic acidosis. High Cl- may reduce GFR.",
    distribution: 'ecf'
  },
  hartmanns: {
    name: "Hartmann's",
    na: 131, cl: 111, k: 5, mg: 0, ca: 2, organic: 29, albuminContent: 0, hco3_load: 0, osm: 274,
    description: "Balanced. Lactate->Bicarb. pH neutral.",
    distribution: 'ecf'
  },
  plasmalyte: {
    name: "Plasma-Lyte 148",
    na: 140, cl: 98, k: 5, mg: 1.5, ca: 0, organic: 50, albuminContent: 0, hco3_load: 0, osm: 295,
    description: "Balanced. Acetate/Gluconate->Bicarb.",
    distribution: 'ecf'
  },
  albumin4: {
    name: "Albumin 4%",
    na: 140, cl: 128, k: 0, mg: 0, ca: 0, organic: 0, albuminContent: 40, hco3_load: 0, osm: 290,
    description: "Iso-oncotic. Weak acid load (Atot).",
    distribution: 'plasma'
  },
  albumin20: {
    name: "Albumin 20%",
    na: 140, cl: 120, k: 0, mg: 0, ca: 0, organic: 0, albuminContent: 200, hco3_load: 0, osm: 310,
    description: "Hyper-oncotic. Recruits ISF to Plasma.",
    distribution: 'plasma_expand'
  },
  bicarb_dex: {
    name: "NaHCO3 + D5W",
    na: 140, cl: 0, k: 0, mg: 0, ca: 0, organic: 0, albuminContent: 0, hco3_load: 140, osm: 550, // Hypertonic initially but D5W free water
    description: "Free water (ICF swell) + Alkalosis.",
    distribution: 'tbw'
  },
  mannitol: {
    name: "Mannitol 20%",
    na: 0, cl: 0, k: 0, mg: 0, ca: 0, organic: 0, albuminContent: 0, hco3_load: 0, osm: 1098,
    description: "Osmotic diuretic. Shrinks cells.",
    distribution: 'ecf' // Treats ECF but draws from ICF
  }
};

// --- Physiological Baselines (70kg Male) ---
const BASE_TBW = 42;
const BASE_ECF_VOL = 14; 
const BASE_ISF_VOL = 10.5;
const BASE_PV_VOL = 3.5;
const BASE_OSM = 285;

// Electrolytes
const BASE_NA = 140; const BASE_CL = 100; const BASE_K = 4.0;
const BASE_MG = 1.0; const BASE_CA = 1.2; const BASE_ALB = 40;

// Kinetics
const K_REDIST_CRYSTALLOID = 0.15; 
const K_REDIST_SEPSIS = 0.45; // Glycocalyx breakdown
const K_RENAL_BASE = 0.02; // L/min max clearance approx

// --- Helper: Simulation Step Engine ---
interface SimState {
  plasma: number; isf: number; icf: number; urine: number;
  na: number; cl: number; k: number; hco3: number; alb: number;
  ph: number; osm: number; sid: number;
}

const runPhysicsStep = (
  prev: SimState, 
  fluid: FluidData, 
  dt: number, 
  infusionRate: number, // L/min
  isSepsis: boolean,
  isRenalImpairment: boolean = false
): SimState => {
  
  // 1. Infusion
  const infusedVol = infusionRate * dt;
  let newPlasma = prev.plasma + infusedVol;
  let newISF = prev.isf;
  let newICF = prev.icf;
  
  // 2. Redistribution
  const leakRate = isSepsis ? K_REDIST_SEPSIS : K_REDIST_CRYSTALLOID;
  
  if (fluid.distribution === 'ecf' || fluid.name.includes('Mannitol')) {
     const gradient = (newPlasma / BASE_PV_VOL) - (newISF / BASE_ISF_VOL);
     if (gradient > 0) {
        const flux = gradient * leakRate * dt; 
        newPlasma -= flux; newISF += flux;
     }
  } else if (fluid.distribution === 'plasma_expand') {
      const pull = 0.05 * dt; 
      if (newISF > BASE_ISF_VOL * 0.8) { 
         newPlasma += pull; newISF -= pull;
      }
  } else if (fluid.distribution === 'tbw') {
      const flux = 0.2 * dt;
      newPlasma -= flux * 0.2;
      newISF -= flux * 0.2;
      newICF += flux * 0.4;
  }
  
  if (fluid.name.includes('Mannitol')) {
      const osmoticPull = 0.1 * dt;
      newICF -= osmoticPull;
      newPlasma += osmoticPull;
  }

  // 3. Renal Clearance
  const clPenalty = (fluid.cl > 140 && infusionRate > 0) ? 0.7 : 1.0;
  const volStatus = newPlasma / BASE_PV_VOL;
  let urineRate = (volStatus > 1 ? (volStatus - 1) * K_RENAL_BASE : 0.001) * clPenalty;
  
  if (isRenalImpairment) urineRate *= 0.1; 

  const urineVol = urineRate * dt;
  newPlasma -= urineVol;
  const totalUrine = prev.urine + urineVol;

  // 4. Electrolyte Mixing
  const totalVolECF = newPlasma + newISF + BASE_ECF_VOL; 
  
  const mix = 0.1; 
  const nextNa = prev.na + (fluid.na - prev.na) * (infusedVol / totalVolECF) * mix;
  const nextCl = prev.cl + (fluid.cl - prev.cl) * (infusedVol / totalVolECF) * mix;
  const nextAlb = prev.alb + (fluid.albuminContent - prev.alb) * (infusedVol / totalVolECF) * mix;
  
  // SID & pH
  const strongCations = nextNa + BASE_K + (BASE_MG*2) + (BASE_CA*2); // Simplified
  const sid = strongCations - nextCl;
  const atot = nextAlb * 0.28; 
  const hco3 = Math.max(0, sid - atot); // Simplified Stewart
  const ph = 6.1 + Math.log10(hco3 / 1.2);

  let nextOsm = prev.osm;
  if (fluid.osm > 300) nextOsm += 0.5 * dt;
  if (fluid.osm < 280) nextOsm -= 0.5 * dt;

  return {
    plasma: newPlasma, isf: newISF, icf: newICF, urine: totalUrine,
    na: nextNa, cl: nextCl, k: prev.k, hco3, alb: nextAlb,
    ph, osm: nextOsm, sid
  };
};


// --- COMPONENT: Stewart & Gamblegram (Main) ---
const StewartSimulator = () => {
  const [selectedFluid, setSelectedFluid] = useState<FluidType>('saline');
  const [targetVolume, setTargetVolume] = useState<number>(1000); 
  const [isPlaying, setIsPlaying] = useState(false);
  const [sepsisMode, setSepsisMode] = useState(false);
  
  const [state, setState] = useState<SimState>({
    plasma: 0, isf: 0, icf: 0, urine: 0,
    na: BASE_NA, cl: BASE_CL, k: BASE_K, hco3: 24, alb: BASE_ALB,
    ph: 7.4, osm: 285, sid: 40
  });

  useEffect(() => {
    let interval: NodeJS.Timeout;
    if (isPlaying) {
      interval = setInterval(() => {
        setState(prev => {
           const dt = 0.5; // mins
           const rate = (targetVolume/1000) / 30; 
           const isInfusing = prev.plasma < (targetVolume/1000) * 1.5; 
           
           return runPhysicsStep(prev, FLUIDS[selectedFluid], dt, isInfusing ? rate : 0, sepsisMode);
        });
      }, 50);
    }
    return () => clearInterval(interval);
  }, [isPlaying, selectedFluid, targetVolume, sepsisMode]);

  const reset = () => {
    setIsPlaying(false);
    setState({
        plasma: 0, isf: 0, icf: 0, urine: 0,
        na: BASE_NA, cl: BASE_CL, k: BASE_K, hco3: 24, alb: BASE_ALB,
        ph: 7.4, osm: 285, sid: 40
    });
  };

  const cellRadius = 40 * (285 / state.osm);
  const scale = 3.0; // Scale for Gamblegram

  return (
    <div className="grid grid-cols-1 lg:grid-cols-12 gap-6">
      {/* CONTROLS */}
      <div className="lg:col-span-3 space-y-4">
        <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-200 space-y-4">
           <h3 className="font-bold text-slate-700 uppercase text-xs tracking-wider">Infusion Protocol</h3>
           <select 
              value={selectedFluid} onChange={(e) => setSelectedFluid(e.target.value as FluidType)}
              className="w-full p-2 border rounded text-sm font-semibold"
           >
              {Object.entries(FLUIDS).map(([k,v]) => <option key={k} value={k}>{v.name}</option>)}
           </select>
           
           <div className="flex items-center gap-2 text-sm">
             <span className="font-semibold text-xs">Sepsis Mode</span>
             <button 
               onClick={() => setSepsisMode(!sepsisMode)}
               className={`w-10 h-5 rounded-full transition-colors relative ${sepsisMode ? 'bg-red-500' : 'bg-slate-300'}`}
             >
                <div className={`absolute top-1 w-3 h-3 bg-white rounded-full transition-all ${sepsisMode ? 'left-6' : 'left-1'}`} />
             </button>
           </div>

           <div className="flex gap-2">
              <button onClick={() => setIsPlaying(!isPlaying)} className="flex-1 btn-primary py-2 rounded bg-blue-600 text-white font-bold text-sm flex items-center justify-center gap-2">
                {isPlaying ? <Pause size={16}/> : <Play size={16}/>} {isPlaying ? 'Pause' : 'Infuse'}
              </button>
              <button onClick={reset} className="p-2 bg-slate-100 rounded hover:bg-slate-200"><RotateCcw size={18}/></button>
           </div>
        </div>
        
        <div className="bg-slate-800 text-white p-4 rounded-xl space-y-3 text-sm">
           <div className="flex justify-between border-b border-slate-600 pb-2"><span>pH</span><span className={`font-mono font-bold text-lg ${state.ph < 7.35 ? 'text-red-400' : 'text-green-400'}`}>{state.ph.toFixed(2)}</span></div>
           <div className="flex justify-between"><span>SID (mEq/L)</span><span className="font-mono font-bold">{state.sid.toFixed(1)}</span></div>
           <div className="flex justify-between"><span>HCO3 (mmol)</span><span className="font-mono font-bold text-green-400">{state.hco3.toFixed(1)}</span></div>
        </div>

        {/* Volume Buckets Mini-View */}
        <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-200 h-48 flex items-end justify-center gap-2 relative">
             <div className="absolute top-2 left-2 text-[10px] font-bold text-slate-400 uppercase">Volume Status</div>
             <div className="w-1/3 bg-red-100 rounded-t h-full flex items-end relative">
                <div className="w-full bg-red-500 transition-all duration-300" style={{ height: `${20 + (state.plasma/3)*80}%` }}></div>
                <div className="absolute bottom-1 left-0 w-full text-center text-[10px] font-bold text-white mix-blend-difference">Plasma</div>
             </div>
             <div className="w-1/3 bg-blue-100 rounded-t h-full flex items-end relative">
                <div className="w-full bg-blue-400 transition-all duration-300" style={{ height: `${30 + (state.isf/5)*70}%` }}></div>
                <div className="absolute bottom-1 left-0 w-full text-center text-[10px] font-bold text-white mix-blend-difference">Edema</div>
             </div>
             <div className="w-1/3 bg-yellow-50 rounded-t h-full flex items-end border border-yellow-100 relative">
                <div className="w-full bg-yellow-400 transition-all duration-300" style={{ height: `${(state.urine/2)*100}%` }}></div>
                <div className="absolute bottom-1 left-0 w-full text-center text-[10px] font-bold text-yellow-800">Urine</div>
             </div>
        </div>
      </div>

      {/* GAMBLEGRAM (HERO) */}
      <div className="lg:col-span-9 bg-white p-6 rounded-xl shadow-sm border border-slate-200 flex flex-col relative overflow-hidden">
          <h2 className="text-lg font-bold text-slate-800 mb-6 flex items-center gap-2 border-b pb-2">
            <Beaker className="text-blue-600"/> Gamblegram: Strong Ion Difference (SID)
          </h2>
          
          <div className="flex-1 flex items-end justify-center gap-12 select-none pb-8 overflow-x-auto">
             
             {/* CATIONS */}
             <div className="w-32 flex flex-col shadow-2xl shadow-slate-200 group relative">
                <div className="absolute -top-8 w-full text-center font-bold text-slate-400 text-xs uppercase tracking-wider">Strong Cations</div>
                
                {/* Mg/Ca/K */}
                <div className="bg-amber-300 w-full flex items-center justify-center text-xs font-bold text-amber-900 border-b border-white/20" style={{ height: `${(4.4 + 2.2) * scale}px` }}>
                   Mg/Ca/K
                </div>
                {/* Na */}
                <div className="bg-red-500 w-full flex items-center justify-center text-white font-bold rounded-b-lg text-xl" style={{ height: `${state.na * scale}px` }}>
                   Na⁺
                   <span className="text-xs ml-1 opacity-70 font-normal">{state.na.toFixed(0)}</span>
                </div>
             </div>

             {/* ANIONS */}
             <div className="w-32 flex flex-col shadow-2xl shadow-slate-200 relative">
                <div className="absolute -top-8 w-full text-center font-bold text-slate-400 text-xs uppercase tracking-wider">Anions</div>
                
                {/* Albumin (Weak Acid) */}
                <div className="bg-purple-400 w-full flex flex-col items-center justify-center text-xs font-bold text-white border-b border-white/20 transition-all duration-500" style={{ height: `${(state.alb * 0.28) * scale}px` }}>
                   <span>A⁻ (Alb)</span>
                </div>

                {/* HCO3 */}
                <div className="bg-green-500 w-full flex flex-col items-center justify-center text-white font-bold border-b border-white/20 relative transition-all duration-500" style={{ height: `${state.hco3 * scale}px` }}>
                   <span className="text-xl">HCO₃⁻</span>
                   <span className="text-xs opacity-80">{state.hco3.toFixed(1)}</span>
                   
                   {/* SID Indicator */}
                   <div className="absolute -right-6 top-0 border-r-4 border-slate-400 border-t-4 border-b-4 rounded-r-lg flex items-center justify-center" 
                        style={{ height: `${(state.hco3 + (state.alb*0.28)) * scale}px`, top: `-${(state.alb*0.28) * scale}px`, width: '12px' }}>
                   </div>
                   <div className="absolute -right-24 top-0 text-sm font-bold text-slate-500 transform -translate-y-[50%] -mt-[50%]" 
                        style={{ top: `-${(state.alb*0.28) * scale * 0.5}px` }}>
                        SID ({state.sid.toFixed(0)})
                   </div>
                </div>

                {/* Chloride */}
                <div className="bg-blue-500 w-full flex items-center justify-center text-white font-bold rounded-b-lg text-xl transition-all duration-500" style={{ height: `${state.cl * scale}px` }}>
                   Cl⁻
                   <span className="text-xs ml-1 opacity-70 font-normal">{state.cl.toFixed(0)}</span>
                </div>
             </div>
          </div>

          <div className="bg-slate-50 p-4 rounded-lg text-sm text-slate-600 border border-slate-200 mt-4">
             <p className="font-bold mb-1">Key Concept: Electroneutrality</p>
             <p>The body must maintain balanced charge. The <strong>Strong Ion Difference (SID)</strong> is the space left between Strong Cations (Na⁺) and Strong Anions (Cl⁻). This space is filled by Weak Acids (Albumin) and Bicarbonate. </p>
             <p className="mt-2 text-blue-700">If you infuse Saline (High Cl⁻), the Chloride bar rises, shrinking the SID. Bicarbonate is squeezed out → <strong>Metabolic Acidosis</strong>.</p>
          </div>
      </div>
    </div>
  );
};

// --- COMPONENT: Micro-Physiology (Cellular) ---
const CellularView = () => {
  const [ph, setPh] = useState(7.4);
  const k_ecf = 4.0 + (7.4 - ph) * 6; 
  
  return (
     <div className="grid grid-cols-1 md:grid-cols-2 gap-8 items-center h-full max-w-4xl mx-auto">
        <div className="space-y-6">
           <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
              <h3 className="font-bold text-slate-800 mb-4">Extracellular pH</h3>
              <input type="range" min="6.9" max="7.6" step="0.05" value={ph} onChange={e => setPh(Number(e.target.value))} className="w-full h-2 bg-slate-200 rounded-lg accent-blue-600 mb-2"/>
              <div className="flex justify-between font-mono font-bold"><span className="text-red-500">Acidosis (6.9)</span><span className="text-slate-800">{ph}</span><span className="text-blue-500">Alkalosis (7.6)</span></div>
           </div>
           <div className="bg-blue-50 p-4 rounded-lg text-sm text-slate-700">
              <p className="font-bold mb-2">H⁺/K⁺ Exchange:</p>
              <ul className="list-disc ml-4 space-y-1"><li>In Acidosis, high ECF H⁺ drives H⁺ into the cell to be buffered.</li><li>To maintain electroneutrality, K⁺ is extruded.</li><li>Result: Hyperkalaemia.</li></ul>
           </div>
        </div>
        <div className="relative h-[400px] w-full bg-sky-50 rounded-xl border-4 border-sky-100 overflow-hidden shadow-inner">
           <div className="absolute top-4 left-4 font-bold text-sky-800 uppercase tracking-widest text-xs">Extracellular Fluid</div>
           <div className="absolute top-1/2 left-0 w-full h-4 bg-yellow-200 border-y-2 border-yellow-400 flex items-center justify-center z-10"><span className="text-[10px] font-bold text-yellow-700 bg-yellow-100 px-2 rounded">Cell Membrane</span></div>
           <div className="absolute bottom-0 w-full h-[48%] bg-pink-50"><div className="absolute bottom-4 left-4 font-bold text-pink-800 uppercase tracking-widest text-xs">Intracellular Fluid</div></div>
           <div className="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-24 h-24 bg-white rounded-full border-4 border-slate-300 shadow-lg z-20 flex flex-col items-center justify-center text-xs font-bold">
              <div className="flex gap-2 items-center text-red-600 animate-pulse"><ArrowRight size={14} className="rotate-90"/> H⁺</div>
              <div className="w-full h-px bg-slate-200 my-1"></div>
              <div className="flex gap-2 items-center text-yellow-600 animate-pulse"><ArrowRight size={14} className="-rotate-90"/> K⁺</div>
           </div>
           <div className="absolute top-20 left-20 text-xl font-bold text-yellow-600 transition-all duration-500" style={{ transform: `scale(${k_ecf/4})` }}>[K⁺] {k_ecf.toFixed(1)}</div>
           <div className="absolute top-20 right-20 text-xl font-bold text-red-600 transition-all duration-500" style={{ opacity: (7.45 - ph) * 2 }}>H⁺ (High)</div>
        </div>
     </div>
  );
};

// --- COMPONENT: Comparator ---
const ComparatorView = () => {
  const [fluidA, setFluidA] = useState<FluidType>('saline');
  const [fluidB, setFluidB] = useState<FluidType>('plasmalyte');

  // Simulated Trajectory
  const trajectory = useMemo(() => {
     const steps = [];
     let phA = 7.4, phB = 7.4;
     for (let t=0; t<=120; t+=10) {
        if (fluidA === 'saline') phA -= 0.005;
        if (fluidA === 'bicarb_dex') phA += 0.008;
        if (fluidB === 'plasmalyte' || fluidB === 'hartmanns') phB += 0.0001; 
        steps.push({ t, phA, phB });
     }
     return steps;
  }, [fluidA, fluidB]);

  return (
    <div className="space-y-6 max-w-4xl mx-auto">
       <div className="flex gap-4">
          <div className="flex-1 bg-white p-4 rounded border-l-4 border-blue-500 shadow-sm"><select value={fluidA} onChange={e => setFluidA(e.target.value as FluidType)} className="w-full font-bold text-blue-800">{Object.entries(FLUIDS).map(([k,v]) => <option key={k} value={k}>{v.name}</option>)}</select></div>
          <div className="flex items-center text-slate-400 font-bold">VS</div>
          <div className="flex-1 bg-white p-4 rounded border-l-4 border-green-500 shadow-sm"><select value={fluidB} onChange={e => setFluidB(e.target.value as FluidType)} className="w-full font-bold text-green-800">{Object.entries(FLUIDS).map(([k,v]) => <option key={k} value={k}>{v.name}</option>)}</select></div>
       </div>
       <div className="bg-white p-6 rounded-xl border border-slate-200">
          <h3 className="font-bold text-slate-700 mb-6">pH Trend (2 Hours)</h3>
          <div className="h-64 flex items-end gap-2 relative border-l border-b border-slate-300 pl-2 pb-2">
             {trajectory.map((pt, i) => (
                <div key={i} className="flex-1 flex flex-col justify-end h-full gap-1 relative"><div className="w-3 bg-blue-500 rounded-full absolute transition-all" style={{ bottom: `${(pt.phA - 7.2) * 400}px`, left: '20%' }} /><div className="w-3 bg-green-500 rounded-full absolute transition-all" style={{ bottom: `${(pt.phB - 7.2) * 400}px`, right: '20%' }} /></div>
             ))}
             <div className="absolute w-full border-t border-dashed border-slate-400" style={{ bottom: `${(7.4 - 7.2) * 400}px` }}><span className="text-xs bg-white text-slate-500 px-1 absolute -top-2 right-0">pH 7.40</span></div>
          </div>
       </div>
    </div>
  );
};

// --- COMPONENT: Cases ---
const CaseSimulator = () => {
  const [scenario, setScenario] = useState('sepsis');
  const [status, setStatus] = useState({ map: 55, hr: 120, ph: 7.25, fluidGiven: 0, lungs: 'Clear' });
  const [msg, setMsg] = useState("");

  const treat = (action: string) => {
     let s = { ...status };
     let m = "";
     if (action === 'fluid') {
        s.fluidGiven += 0.5;
        if (scenario === 'sepsis') {
            s.map += 5; s.hr -= 5;
            if (s.fluidGiven > 2.5) { s.lungs = 'Crackles'; m = "Warning: Pulmonary Edema!"; }
            else m = "BP improved slightly. Tachycardia improving.";
        } else if (scenario === 'dka') {
            s.ph += 0.05; s.hr -= 10; s.map += 2; m = "Acidosis resolving.";
        }
     } else if (action === 'norad') {
         if (s.fluidGiven < 1 && scenario !== 'dka') { s.map += 15; m = "BP up, but organs poorly perfused."; }
         else { s.map += 10; m = "Vasopressor effective."; }
     }
     setStatus(s); setMsg(m);
  };

  return (
    <div className="grid grid-cols-1 md:grid-cols-2 gap-6 max-w-5xl mx-auto">
       <div className="space-y-4">
          <div className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
             <div className="flex gap-2"><button onClick={() => setScenario('sepsis')} className={`flex-1 py-2 rounded font-bold ${scenario==='sepsis'?'bg-red-100 text-red-800':'bg-slate-100'}`}>Septic Shock</button><button onClick={() => setScenario('dka')} className={`flex-1 py-2 rounded font-bold ${scenario==='dka'?'bg-purple-100 text-purple-800':'bg-slate-100'}`}>DKA</button></div>
          </div>
          <div className="bg-slate-800 text-white p-6 rounded-xl space-y-4">
             <div className="flex items-center gap-4"><Activity className="text-green-400" /><div><div className="text-xs text-slate-400 uppercase">HR</div><div className="text-2xl font-mono font-bold">{status.hr}</div></div></div>
             <div className="flex items-center gap-4"><Stethoscope className="text-blue-400" /><div><div className="text-xs text-slate-400 uppercase">MAP</div><div className="text-2xl font-mono font-bold">{status.map}</div></div></div>
             <div className="flex items-center gap-4"><Thermometer className="text-yellow-400" /><div><div className="text-xs text-slate-400 uppercase">Lungs</div><div className={`text-xl font-bold ${status.lungs === 'Crackles' ? 'text-red-400 animate-pulse' : 'text-white'}`}>{status.lungs}</div></div></div>
          </div>
       </div>
       <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm flex flex-col justify-between">
          <div><h3 className="font-bold text-slate-800 mb-4">Interventions</h3><div className="grid grid-cols-2 gap-3"><button onClick={() => treat('fluid')} className="p-3 bg-blue-100 text-blue-800 rounded font-bold flex flex-col items-center"><Droplet size={20}/> 500ml Fluid</button><button onClick={() => treat('norad')} className="p-3 bg-amber-100 text-amber-800 rounded font-bold flex flex-col items-center"><Zap size={20}/> Noradrenaline</button></div></div>
          <div className="mt-6 bg-slate-50 p-4 rounded border border-slate-200"><h4 className="text-xs font-bold text-slate-400 uppercase mb-2">Log</h4><p className="text-sm font-medium text-slate-800">{msg || "Awaiting orders."}</p></div>
       </div>
    </div>
  );
};

// --- COMPONENT: Starling ---
const FrankStarlingSimulator = () => {
    const [preload, setPreload] = useState(10);
    const [inotropy, setInotropy] = useState(1.0);
    const maxSV = 100 * inotropy; 
    const currentSV = maxSV * (1 - Math.exp(-0.1 * preload));

    const generatePath = () => {
        let d = "M 0 300 ";
        for (let x = 0; x <= 30; x += 0.5) { d += `L ${x * 20} ${300 - ((maxSV * (1 - Math.exp(-0.1 * x))) * 2.5)} `; }
        return d;
    };

    return (
       <div className="grid grid-cols-1 md:grid-cols-3 gap-6 max-w-5xl mx-auto">
           <div className="bg-white p-4 rounded-xl border border-slate-200 space-y-6">
               <div><label className="text-xs font-bold text-slate-500 uppercase">Preload</label><input type="range" min="0" max="30" value={preload} onChange={e=>setPreload(Number(e.target.value))} className="w-full h-2 bg-blue-100 rounded-lg accent-blue-600"/></div>
               <div><label className="text-xs font-bold text-slate-500 uppercase">Inotropy</label><input type="range" min="0.5" max="2.0" step="0.1" value={inotropy} onChange={e=>setInotropy(Number(e.target.value))} className="w-full h-2 bg-green-100 rounded-lg accent-green-600"/></div>
               <div className="bg-slate-50 p-3 rounded text-center"><span className="text-xs text-slate-400 uppercase block">Stroke Volume</span><span className="font-mono font-bold text-xl text-pink-600">{currentSV.toFixed(1)} mL</span></div>
           </div>
           <div className="md:col-span-2 bg-white p-4 rounded-xl border border-slate-200 h-[300px]">
               <svg viewBox="0 0 650 300" className="w-full h-full overflow-visible">
                   <defs><pattern id="g" width="20" height="20" patternUnits="userSpaceOnUse"><path d="M 20 0 L 0 0 0 20" fill="none" stroke="#f1f5f9"/></pattern></defs>
                   <rect width="650" height="300" fill="url(#g)" />
                   <path d={generatePath()} fill="none" stroke="#db2777" strokeWidth="4" strokeLinecap="round"/>
                   <circle cx={preload * 20} cy={300 - (currentSV * 2.5)} r="8" fill="white" stroke="#2563eb" strokeWidth="3" />
               </svg>
           </div>
       </div>
    );
};

// --- MAIN APP SHELL ---
const App = () => {
  const [view, setView] = useState<TabView>('stewart');

  const tabs: {id: TabView, label: string, icon: any}[] = [
      { id: 'stewart', label: 'Stewart & SID', icon: Beaker },
      { id: 'starling', label: 'Haemodynamics', icon: HeartPulse },
      { id: 'micro', label: 'Micro', icon: Zap },
      { id: 'comparator', label: 'Compare', icon: GitCompare },
      { id: 'cases', label: 'Cases', icon: UserCheck },
  ];

  return (
    <div className="min-h-screen bg-slate-50 font-sans text-slate-800 p-4 md:p-6 pb-20">
      <div className="max-w-7xl mx-auto space-y-6">
        <header className="flex flex-col md:flex-row justify-between items-center border-b border-slate-200 pb-4 gap-4">
           <div><h1 className="text-2xl font-bold text-slate-900 flex items-center gap-2"><Activity className="text-blue-600"/> Physiology Sandbox</h1></div>
           <div className="flex flex-wrap gap-2 justify-center">
              {tabs.map(t => (
                  <button key={t.id} onClick={() => setView(t.id)} className={`px-3 py-2 rounded-lg text-sm font-bold flex items-center gap-2 transition-all ${view === t.id ? 'bg-slate-800 text-white shadow-lg' : 'bg-white text-slate-500 hover:bg-slate-100 border border-slate-200'}`}>
                     <t.icon size={16}/> {t.label}
                  </button>
              ))}
           </div>
        </header>
        <main className="animate-in fade-in slide-in-from-bottom-4 duration-500">
            {view === 'stewart' && <StewartSimulator />}
            {view === 'micro' && <CellularView />}
            {view === 'starling' && <FrankStarlingSimulator />}
            {view === 'comparator' && <ComparatorView />}
            {view === 'cases' && <CaseSimulator />}
        </main>
      </div>
    </div>
  );
};

export default App;

